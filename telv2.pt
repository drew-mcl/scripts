# -*- coding: utf-8 -*-
# Copyright (c) 2025, Sky Net Systems
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later
"""
`skynet_reporting.py` – Modern OpenTelemetry callback plugin for **Ansible 2.14+**

Highlights
==========
* **Native TLS** – uses the system trust store (`ssl.create_default_context()`), so
  no custom CA bundle is required on RHEL / other Linux distros.
* **OpenTelemetry Semantic Conventions** – attributes prefixed with `ansible.*`,
  `host.*`, `code.*`, giving you rich service‑maps out‑of‑the-box.
* **Resilient config** – any unknown/typo option is ignored (with a warning)
  instead of breaking plugin loading.
* **Fast & lightweight** – spans are batched with the default exporter limits;
  only a tiny in‑memory dict is used to stash task start times.
* **Debug toggle** – set `ANSIBLE_SKYNET_DEBUG_LOGGING=true` (or the ini option)
  to stream detailed state to the Ansible console.

Add to `ansible.cfg`::

    [defaults]
    callbacks_enabled = skynet_reporting
    callback_plugins  = ./callback_plugins

    [callback_skynet_reporting]
    endpoint  = https://otel‑collector.internal:4317
    neuron_team = trading
    neuron_app  = fx‑pricing
    otlp_insecure = false  # Set to true to disable TLS
    enable_debug_logging = true

Environment variables still take precedence (`OTEL_EXPORTER_OTLP_ENDPOINT`,
`OTEL_EXPORTER_OTLP_INSECURE`, etc.).
"""
from __future__ import annotations

import os
from dataclasses import dataclass, field
from time import time_ns
from typing import Any, Dict, Optional
from os.path import basename

from ansible.errors import AnsibleError
from ansible.module_utils.ansible_release import __version__ as ansible_version
from ansible.plugins.callback import CallbackBase

try:
    import grpc
    from opentelemetry import trace
    from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import (
        OTLPSpanExporter as GRPCSpanExporter,
    )
    from opentelemetry.exporter.otlp.proto.http.trace_exporter import (
        OTLPSpanExporter as HTTPSpanExporter,
    )
    from opentelemetry.propagate import get_global_textmap
    from opentelemetry.sdk.resources import SERVICE_NAME, Resource
    from opentelemetry.sdk.trace import TracerProvider
    from opentelemetry.sdk.trace.export import BatchSpanProcessor
    from opentelemetry.trace import SpanKind
    from opentelemetry.trace.status import Status, StatusCode

    _HAS_OTEL = True
except ImportError as exc:  # pragma: no cover – runtime guard
    _HAS_OTEL = False
    _OTEL_IMPORT_ERROR = exc

__all__ = ["CallbackModule"]

# ---------------------------------------------------------------------------
# Mandatory Ansible metadata (DOCUMENTATION / EXAMPLES)
# ---------------------------------------------------------------------------
DOCUMENTATION = r"""
callback: skynet_reporting
short_description: High‑signal OpenTelemetry traces for every Ansible task.
version_added: "1.0.0"
author: Drew Mclachlan <drew@skynet.systems>
description:
  - Sends one span per task per host to an OTLP collector using the system CA
    trust store (gRPC or HTTP/Protobuf).
options:
  endpoint:
    type: str
    description: OTLP collector endpoint (e.g. C(https://otel.internal:4317)).
    ini:
      - section: callback_skynet_reporting
        key: endpoint
    env:
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
  neuron_team:
    type: str
    description: Team responsible for the run (for service name).
    ini:
      - section: callback_skynet_reporting
        key: neuron_team
    env:
      - name: NEURON_TEAM
  neuron_app:
    type: str
    description: Application being deployed (for service name).
    ini:
      - section: callback_skynet_reporting
        key: neuron_app
    env:
      - name: NEURON_APP
  traceparent:
    type: str
    description: W3C traceparent header to link with upstream trace.
    env:
      - name: TRACEPARENT
  otlp_insecure:
    type: bool
    default: false
    description: "Disable TLS verification for the OTLP endpoint. Maps to OTEL_EXPORTER_OTLP_INSECURE."
    ini:
      - section: callback_skynet_reporting
        key: otlp_insecure
    env:
      - name: OTEL_EXPORTER_OTLP_INSECURE
  enable_debug_logging:
    type: bool
    default: false
    description: Emit verbose plugin logs (requires -vv or higher).
    ini:
      - section: callback_skynet_reporting
        key: enable_debug_logging
    env:
      - name: ANSIBLE_SKYNET_DEBUG_LOGGING
"""

EXAMPLES = r"""
# ansible.cfg
[defaults]
callbacks_enabled = skynet_reporting
callback_plugins  = ./callback_plugins

[callback_skynet_reporting]
endpoint = https://otel.internal:4317
neuron_team = trading
neuron_app  = fx-pricing
otlp_insecure = false
enable_debug_logging = true
"""

# ---------------------------------------------------------------------------
# Helper dataclasses
# ---------------------------------------------------------------------------
@dataclass
class _TaskKey:
    task_uuid: str
    host_uuid: str

    def __hash__(self):
        return hash((self.task_uuid, self.host_uuid))


@dataclass
class _TaskMeta:
    span_name: str
    start_ns: int
    attrs: Dict[str, Any] = field(default_factory=dict)


# ---------------------------------------------------------------------------
# Configuration resolver
# ---------------------------------------------------------------------------
class _Config:
    """Resolve ini → env → defaults with graceful fall‑backs."""

    def __init__(self, cb: "CallbackModule"):
        self._cb = cb

    # Generic accessor -----------------------------------------------------
    def _opt(self, key: str, default: Any = None) -> Any:
        try:
            val = self._cb.get_option(key)
        except Exception:  # unknown key / AnsibleOptionError
            return default
        return val if val not in (None, "") else default

    # Convenience wrappers --------------------------------------------------
    @property
    def endpoint(self) -> Optional[str]:
        return self._opt("endpoint") or os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT")

    @property
    def protocol(self) -> str:
        return os.getenv("OTEL_EXPORTER_OTLP_TRACES_PROTOCOL", "grpc").lower()

    @property
    def team(self) -> str:
        return str(self._opt("neuron_team", "unknown_team"))

    @property
    def app(self) -> str:
        return str(self._opt("neuron_app", "unknown_app"))

    @property
    def traceparent(self) -> Optional[str]:
        return self._opt("traceparent")
    
    @property
    def insecure(self) -> bool:
        env_flag = os.getenv("OTEL_EXPORTER_OTLP_INSECURE", "false").lower() == "true"
        return str(self._opt("otlp_insecure", env_flag)).lower() == "true"

    @property
    def debug(self) -> bool:
        env_flag = os.getenv("ANSIBLE_SKYNET_DEBUG_LOGGING", "false").lower() == "true"
        return str(self._opt("enable_debug_logging", env_flag)).lower() == "true"


# ---------------------------------------------------------------------------
# Main callback plugin
# ---------------------------------------------------------------------------
class CallbackModule(CallbackBase):
    CALLBACK_VERSION = 2.0
    CALLBACK_TYPE = "notification"
    CALLBACK_NAME = "skynet_reporting"
    CALLBACK_NEEDS_ENABLED = True

    # ------------------------------------------------------------------
    # Ansible lifecycle hooks
    # ------------------------------------------------------------------
    def __init__(self, display=None):  # noqa: D401 (Ansible signature)
        super().__init__(display=display)
        if not _HAS_OTEL:
            raise AnsibleError(
                "OpenTelemetry libraries missing – `pip install opentelemetry-sdk opentelemetry-exporter-otlp grpcio`"
            ) from _OTEL_IMPORT_ERROR

        self.cfg: Optional[_Config] = None
        self.tracer_provider: Optional[TracerProvider] = None
        self.tracer = None
        self.root_span = None
        self._pending: Dict[_TaskKey, _TaskMeta] = {}
        self._failed = 0

    # Utility ------------------------------------------------------------
    def _dbg(self, msg: str):
        if self.cfg and self.cfg.debug:
            self._display.v(f"[skynet_reporting] {msg}")

    def set_options(self, task_keys=None, var_options=None, direct=None):  # noqa: N802
        super().set_options(task_keys=task_keys, var_options=var_options, direct=direct)
        self.cfg = _Config(self)
        if self.cfg.debug:
            self._display.banner("[skynet_reporting] Debug logging enabled")

    # OpenTelemetry bootstrap -------------------------------------------
    def _ensure_tracer(self):
        if self.tracer or not self.cfg:
            return
        if not self.cfg.endpoint:
            self._display.warning("[skynet_reporting] No OTLP endpoint – spans will not be exported.")
            return

        resource = Resource.create({SERVICE_NAME: f"ansible.skynet.{self.cfg.team}.{self.cfg.app}"})
        self.tracer_provider = TracerProvider(resource=resource)
        
        exporter = None
        if self.cfg.protocol == "grpc":
            if self.cfg.insecure:
                self._dbg("gRPC exporter configured with insecure=True")
                exporter = GRPCSpanExporter(endpoint=self.cfg.endpoint, insecure=True)
            else:
                self._dbg("gRPC exporter configured with system TLS credentials")
                credentials = grpc.ssl_channel_credentials()
                exporter = GRPCSpanExporter(endpoint=self.cfg.endpoint, credentials=credentials)
        elif self.cfg.protocol in {"http", "http/protobuf"}:
            # NOTE: The HTTP exporter respects http/https in the endpoint URL and
            # the standard OTEL_EXPORTER_OTLP_CERTIFICATE env var automatically.
            exporter = HTTPSpanExporter(endpoint=self.cfg.endpoint)
        else:
            self._display.warning(f"[skynet_reporting] Unsupported protocol '{self.cfg.protocol}'.")
            return

        self.tracer_provider.add_span_processor(BatchSpanProcessor(exporter))
        trace.set_tracer_provider(self.tracer_provider)
        self.tracer = trace.get_tracer(__name__, ansible_version)
        self._dbg("Tracer initialised.")

    # Playbook start -----------------------------------------------------
    def v2_playbook_on_start(self, playbook):  # noqa: N802
        self._ensure_tracer()
        if not self.tracer:
            return

        name = basename(playbook._file_name)
        carrier = {"traceparent": self.cfg.traceparent} if self.cfg and self.cfg.traceparent else None
        parent_ctx = get_global_textmap().extract(carrier) if carrier else trace.INVALID_SPAN_CONTEXT

        self.root_span = self.tracer.start_span(
            name=f"playbook:{name}", kind=SpanKind.SERVER, context=parent_ctx
        )
        self.root_span.set_attribute("ansible.playbook.name", name)